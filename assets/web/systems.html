<input type="file" id="fileInput" class="file-input" accept=".img,.iso,.tar,.gz,.zip">
            </div>
            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="uploadStatus"></div>
        </div>
    </div>

    <!-- Install Modal -->
    <div id="installModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">🔧 تثبيت نظام تشغيل</h2>
                <button class="close-btn" onclick="closeModal('installModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">اسم النظام:</label>
                    <input type="text" id="osName" class="form-input" placeholder="مثال: RetroPie Gaming">
                </div>
                <div class="form-group">
                    <label class="form-label">وصف النظام:</label>
                    <input type="text" id="osDescription" class="form-input" placeholder="وصف مختصر للنظام">
                </div>
                <div class="form-group">
                    <label class="form-label">نوع النظام:</label>
                    <select id="osType" class="form-input">
                        <option value="Unknown">غير محدد</option>
                        <option value="RetroPie">RetroPie</option>
                        <option value="Batocera">Batocera</option>
                        <option value="Recalbox">Recalbox</option>
                        <option value="RaspberryPiOS">Raspberry Pi OS</option>
                        <option value="Ubuntu">Ubuntu</option>
                        <option value="Debian">Debian</option>
                    </select>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="setAsDefault">
                    <label for="setAsDefault">تعيين كنظام افتراضي</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="optimizeForDevice" checked>
                    <label for="optimizeForDevice">تحسين للجهاز الحالي</label>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn success" onclick="startInstallation()">🚀 بدء التثبيت</button>
                    <button class="btn" onclick="closeModal('installModal')">إلغاء</button>
                </div>
            </div>
        </div>
    </div>

    <!-- System Details Modal -->
    <div id="systemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="systemModalTitle">تفاصيل النظام</h2>
                <button class="close-btn" onclick="closeModal('systemModal')">&times;</button>
            </div>
            <div class="modal-body" id="systemModalBody">
                <!-- System details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Backups Modal -->
    <div id="backupsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">💾 النسخ الاحتياطية</h2>
                <button class="close-btn" onclick="closeModal('backupsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="backupsList">
                    <div class="loading"></div>
                    <span>جاري تحميل النسخ الاحتياطية...</span>
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn success" onclick="createFullBackup()">
                        💾 إنشاء نسخة احتياطية كاملة
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">⚠️ تأكيد العملية</h2>
                <button class="close-btn" onclick="closeModal('confirmModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">هل أنت متأكد من تنفيذ هذه العملية؟</p>
                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
                    <button class="btn danger" id="confirmYes">نعم</button>
                    <button class="btn" onclick="closeModal('confirmModal')">إلغاء</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer Navigation -->
    <div class="footer-nav">
        <a href="/" class="nav-item">🏠 الرئيسية</a>
        <a href="/remote" class="nav-item">🎮 تحكم عن بعد</a>
        <a href="/troubleshoot" class="nav-item">🔧 استكشاف أخطاء</a>
        <a href="/systems" class="nav-item active">💿 الأنظمة</a>
        <a href="/settings" class="nav-item">⚙️ الإعدادات</a>
    </div>

    <!-- Notification Container -->
    <div id="notification" class="notification"></div>

    <script>
        // =====================================
        // Global Variables
        // =====================================
        let currentSystems = [];
        let currentBackups = [];
        let selectedFile = null;

        // =====================================
        // Initialization
        // =====================================
        document.addEventListener('DOMContentLoaded', function() {
            loadSystems();
            setupDragAndDrop();
            setupFileInput();
        });

        // =====================================
        // System Loading and Display
        // =====================================
        async function loadSystems() {
            try {
                const response = await fetch('/api/systems');
                const data = await response.json();
                
                if (data.success) {
                    currentSystems = data.data;
                    displaySystems(currentSystems);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('خطأ في تحميل الأنظمة:', error);
                showNotification('فشل في تحميل قائمة الأنظمة', 'error');
                displaySystemsError();
            }
        }

        function displaySystems(systems) {
            const grid = document.getElementById('systemsGrid');
            
            if (!systems || systems.length === 0) {
                grid.innerHTML = `
                    <div class="system-card" style="text-align: center; grid-column: 1 / -1;">
                        <div class="system-icon">📁</div>
                        <h3>لا توجد أنظمة تشغيل مثبتة</h3>
                        <p>ابدأ بتثبيت نظام تشغيل جديد</p>
                        <button class="btn success" onclick="showUploadModal()" style="margin-top: 15px;">
                            📥 تثبيت نظام جديد
                        </button>
                    </div>
                `;
                return;
            }

            grid.innerHTML = systems.map(system => `
                <div class="system-card ${system.is_current ? 'current' : ''}" data-system="${system.name}">
                    <div class="system-header">
                        <div>
                            <div class="system-icon">${getSystemIcon(system.os_type)}</div>
                            <div class="system-name">${system.name}</div>
                            ${system.is_current ? '<span style="color: var(--accent-color); font-size: 0.8em;">● النظام الحالي</span>' : ''}
                        </div>
                        <div class="system-type">${getSystemTypeLabel(system.os_type)}</div>
                    </div>
                    
                    <div class="system-description">${system.description}</div>
                    
                    <div class="system-stats">
                        <div class="stat-item">
                            <div class="stat-label">الحجم</div>
                            <div class="stat-value">${system.size_mb || 0} MB</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">الحالة</div>
                            <div class="stat-value">${system.bootable ? '✅ قابل للتشغيل' : '❌ غير جاهز'}</div>
                        </div>
                        ${system.last_used ? `
                        <div class="stat-item">
                            <div class="stat-label">آخر استخدام</div>
                            <div class="stat-value">${formatDate(system.last_used)}</div>
                        </div>
                        ` : ''}
                        <div class="stat-item">
                            <div class="stat-label">المسار</div>
                            <div class="stat-value" style="font-size: 0.7em; opacity: 0.7;">${system.path}</div>
                        </div>
                    </div>
                    
                    <div class="system-actions">
                        <button class="btn-small btn-boot" onclick="bootSystem('${system.name}')" 
                                ${!system.bootable ? 'disabled' : ''}>
                            🚀 تشغيل
                        </button>
                        <button class="btn-small btn-manage" onclick="showSystemDetails('${system.name}')">
                            ⚙️ إدارة
                        </button>
                        <button class="btn-small btn-backup" onclick="backupSystem('${system.name}')">
                            💾 نسخ احتياطي
                        </button>
                        <button class="btn-small btn-remove" onclick="confirmRemoveSystem('${system.name}')"
                                ${system.is_current ? 'disabled title="لا يمكن حذف النظام الحالي"' : ''}>
                            🗑️ حذف
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function displaySystemsError() {
            const grid = document.getElementById('systemsGrid');
            grid.innerHTML = `
                <div class="system-card" style="text-align: center; grid-column: 1 / -1; border-left: 5px solid var(--danger-color);">
                    <div class="system-icon">❌</div>
                    <h3>خطأ في تحميل الأنظمة</h3>
                    <p>تعذر تحميل قائمة أنظمة التشغيل</p>
                    <button class="btn" onclick="loadSystems()" style="margin-top: 15px;">
                        🔄 إعادة المحاولة
                    </button>
                </div>
            `;
        }

        // =====================================
        // File Upload Handling
        // =====================================
        function setupDragAndDrop() {
            const uploadArea = document.getElementById('uploadArea');
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    selectedFile = files[0];
                    showInstallModal();
                }
            });
        }

        function setupFileInput() {
            const fileInput = document.getElementById('fileInput');
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    selectedFile = e.target.files[0];
                    showInstallModal();
                }
            });
        }

        // =====================================
        // Modal Management
        // =====================================
        function showUploadModal() {
            document.getElementById('uploadSection').style.display = 'block';
            document.getElementById('uploadSection').scrollIntoView({ behavior: 'smooth' });
        }

        function showInstallModal() {
            if (!selectedFile) {
                showNotification('يرجى اختيار ملف أولاً', 'warning');
                return;
            }

            // Auto-fill form based on file name
            const fileName = selectedFile.name.toLowerCase();
            const osNameInput = document.getElementById('osName');
            const osTypeSelect = document.getElementById('osType');
            
            // Extract system name from filename
            let suggestedName = selectedFile.name.replace(/\.(img|iso|tar|gz|zip)$/gi, '');
            osNameInput.value = suggestedName;
            
            // Auto-detect OS type
            if (fileName.includes('retropie')) {
                osTypeSelect.value = 'RetroPie';
            } else if (fileName.includes('batocera')) {
                osTypeSelect.value = 'Batocera';
            } else if (fileName.includes('recalbox')) {
                osTypeSelect.value = 'Recalbox';
            } else if (fileName.includes('raspios') || fileName.includes('raspberry')) {
                osTypeSelect.value = 'RaspberryPiOS';
            } else if (fileName.includes('ubuntu')) {
                osTypeSelect.value = 'Ubuntu';
            }

            document.getElementById('installModal').style.display = 'flex';
        }

        function showSystemDetails(systemName) {
            const system = currentSystems.find(s => s.name === systemName);
            if (!system) return;

            document.getElementById('systemModalTitle').textContent = `تفاصيل ${system.name}`;
            document.getElementById('systemModalBody').innerHTML = `
                <div class="form-group">
                    <label class="form-label">اسم النظام:</label>
                    <input type="text" class="form-input" value="${system.name}" id="editSystemName">
                </div>
                <div class="form-group">
                    <label class="form-label">الوصف:</label>
                    <input type="text" class="form-input" value="${system.description}" id="editSystemDescription">
                </div>
                <div class="form-group">
                    <label class="form-label">النوع:</label>
                    <select class="form-input" id="editSystemType">
                        <option value="RetroPie" ${system.os_type === 'RetroPie' ? 'selected' : ''}>RetroPie</option>
                        <option value="Batocera" ${system.os_type === 'Batocera' ? 'selected' : ''}>Batocera</option>
                        <option value="Recalbox" ${system.os_type === 'Recalbox' ? 'selected' : ''}>Recalbox</option>
                        <option value="RaspberryPiOS" ${system.os_type === 'RaspberryPiOS' ? 'selected' : ''}>Raspberry Pi OS</option>
                        <option value="Ubuntu" ${system.os_type === 'Ubuntu' ? 'selected' : ''}>Ubuntu</option>
                        <option value="Debian" ${system.os_type === 'Debian' ? 'selected' : ''}>Debian</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">المسار:</label>
                    <input type="text" class="form-input" value="${system.path}" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">الحجم:</label>
                    <input type="text" class="form-input" value="${system.size_mb} MB" readonly>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="editSetAsDefault" ${system.is_current ? 'checked' : ''}>
                    <label for="editSetAsDefault">تعيين كنظام افتراضي</label>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn success" onclick="saveSystemChanges('${system.name}')">💾 حفظ التغييرات</button>
                    <button class="btn warning" onclick="optimizeSystem('${system.name}')">⚡ تحسين النظام</button>
                    <button class="btn" onclick="updateSystem('${system.name}')">🔄 تحديث النظام</button>
                </div>
            `;
            
            document.getElementById('systemModal').style.display = 'flex';
        }

        async function showBackupsModal() {
            document.getElementById('backupsModal').style.display = 'flex';
            await loadBackups();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            
            // Reset upload section if install modal is closed
            if (modalId === 'installModal') {
                selectedFile = null;
                document.getElementById('fileInput').value = '';
                document.getElementById('uploadSection').style.display = 'none';
            }
        }

        // =====================================
        // System Operations
        // =====================================
        async function bootSystem(systemName) {
            if (!confirm(`هل تريد تشغيل ${systemName}؟`)) return;

            try {
                showNotification(`جاري تشغيل ${systemName}...`, 'info');
                
                const response = await fetch('/api/boot', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ os_name: systemName })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`تم بدء تشغيل ${systemName} بنجاح`, 'success');
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('خطأ في تشغيل النظام:', error);
                showNotification(`فشل في تشغيل ${systemName}`, 'error');
            }
        }

        async function backupSystem(systemName) {
            if (!confirm(`إنشاء نسخة احتياطية من ${systemName}؟`)) return;

            try {
                showNotification(`جاري إنشاء نسخة احتياطية من ${systemName}...`, 'info');
                
                const response = await fetch(`/api/systems/${systemName}/backup`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`تم إنشاء النسخة الاحتياطية بنجاح`, 'success');
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('خطأ في النسخ الاحتياطي:', error);
                showNotification(`فشل في إنشاء النسخة الاحتياطية`, 'error');
            }
        }

        function confirmRemoveSystem(systemName) {
            showConfirmation(
                `هل أنت متأكد من حذف ${systemName}؟\n\nهذا الإجراء لا يمكن التراجع عنه.`,
                () => removeSystem(systemName)
            );
        }

        async function removeSystem(systemName) {
            try {
                showNotification(`جاري حذف ${systemName}...`, 'info');
                
                const response = await fetch(`/api/systems/${systemName}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ create_backup: true })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`تم حذف ${systemName} بنجاح`, 'success');
                    loadSystems(); // Reload systems list
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('خطأ في حذف النظام:', error);
                showNotification(`فشل في حذف ${systemName}`, 'error');
            }
        }

        async function startInstallation() {
            const osName = document.getElementById('osName').value.trim();
            const osDescription = document.getElementById('osDescription').value.trim();
            const osType = document.getElementById('osType').value;
            const setAsDefault = document.getElementById('setAsDefault').checked;
            const optimizeForDevice = document.getElementById('optimizeForDevice').checked;

            if (!osName) {
                showNotification('يرجى إدخال اسم النظام', 'warning');
                return;
            }

            if (!selectedFile) {
                showNotification('يرجى اختيار ملف النظام', 'warning');
                return;
            }

            // Check if system already exists
            if (currentSystems.find(s => s.name === osName)) {
                if (!confirm(`النظام "${osName}" موجود مسبقاً. هل تريد استبداله؟`)) {
                    return;
                }
            }

            closeModal('installModal');
            await performInstallation(osName, osDescription, osType, setAsDefault, optimizeForDevice);
        }

        async function performInstallation(osName, osDescription, osType, setAsDefault, optimizeForDevice) {
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const uploadStatus = document.getElementById('uploadStatus');

            progressBar.style.display = 'block';
            uploadStatus.innerHTML = `<div class="loading"></div>جاري تثبيت ${osName}...`;

            try {
                // Create FormData for file upload
                const formData = new FormData();
                formData.append('os_file', selectedFile);
                formData.append('os_name', osName);
                formData.append('os_description', osDescription);
                formData.append('os_type', osType);
                formData.append('set_as_default', setAsDefault);
                formData.append('optimize_for_device', optimizeForDevice);

                // Upload with progress tracking
                const xhr = new XMLHttpRequest();
                
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percentComplete = (e.loaded / e.total) * 100;
                        progressFill.style.width = percentComplete + '%';
                        uploadStatus.innerHTML = `جاري الرفع... ${Math.round(percentComplete)}%`;
                    }
                });

                xhr.onload = function() {
                    if (xhr.status === 200) {
                        const response = JSON.parse(xhr.responseText);
                        if (response.success) {
                            progressFill.style.width = '100%';
                            uploadStatus.innerHTML = '✅ تم التثبيت بنجاح!';
                            showNotification(`تم تثبيت ${osName} بنجاح`, 'success');
                            
                            setTimeout(() => {
                                progressBar.style.display = 'none';
                                document.getElementById('uploadSection').style.display = 'none';
                                selectedFile = null;
                                document.getElementById('fileInput').value = '';
                                loadSystems(); // Reload systems
                            }, 2000);
                        } else {
                            throw new Error(response.error);
                        }
                    } else {
                        throw new Error('فشل في الرفع');
                    }
                };

                xhr.onerror = function() {
                    throw new Error('خطأ في الشبكة');
                };

                xhr.open('POST', '/api/systems/install');
                xhr.send(formData);

            } catch (error) {
                console.error('خطأ في التثبيت:', error);
                uploadStatus.innerHTML = '❌ فشل في التثبيت';
                showNotification(`فشل في تثبيت ${osName}: ${error.message}`, 'error');
                
                setTimeout(() => {
                    progressBar.style.display = 'none';
                }, 3000);
            }
        }

        // =====================================
        // Backup Management
        // =====================================
        async function loadBackups() {
            try {
                const response = await fetch('/api/backups');
                const data = await response.json();
                
                if (data.success) {
                    currentBackups = data.data;
                    displayBackups(currentBackups);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('خطأ في تحميل النسخ الاحتياطية:', error);
                document.getElementById('backupsList').innerHTML = 
                    '<p style="color: var(--danger-color);">فشل في تحميل النسخ الاحتياطية</p>';
            }
        }

        function displayBackups(backups) {
            const backupsList = document.getElementById('backupsList');
            
            if (!backups || backups.length === 0) {
                backupsList.innerHTML = '<p>لا توجد نسخ احتياطية</p>';
                return;
            }

            backupsList.innerHTML = backups.map(backup => `
                <div class="backup-item">
                    <div class="backup-info">
                        <div class="backup-name">${backup.os_name}</div>
                        <div class="backup-details">
                            📅 ${formatDate(backup.backup_date)} • 
                            💾 ${backup.backup_size_mb} MB • 
                            ${backup.is_bootable ? '✅ قابل للاستعادة' : '❌ تالف'}
                        </div>
                    </div>
                    <div class="backup-actions">
                        <button class="btn-small btn-boot" onclick="restoreBackup('${backup.backup_path}')"
                                ${!backup.is_bootable ? 'disabled' : ''}>
                            🔄 استعادة
                        </button>
                        <button class="btn-small btn-remove" onclick="deleteBackup('${backup.backup_path}')">
                            🗑️ حذف
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // =====================================
        // Utility Functions
        // =====================================
        function getSystemIcon(osType) {
            const icons = {
                'RetroPie': '🕹️',
                'Batocera': '🎯',
                'Recalbox': '📦',
                'RaspberryPiOS': '🍓',
                'Ubuntu': '🐧',
                'Debian': '🌊',
                'Unknown': '💿'
            };
            return icons[osType] || '💿';
        }

        function getSystemTypeLabel(osType) {
            const labels = {
                'RetroPie': 'ألعاب كلاسيكية',
                'Batocera': 'نظام ألعاب',
                'Recalbox': 'ألعاب قديمة',
                'RaspberryPiOS': 'نظام أساسي',
                'Ubuntu': 'لينكس',
                'Debian': 'لينكس',
                'Unknown': 'غير معروف'
            };
            return labels[osType] || 'نظام تشغيل';
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ar-SA', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        function showConfirmation(message, onConfirm) {
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmYes').onclick = () => {
                closeModal('confirmModal');
                onConfirm();
            };
            document.getElementById('confirmModal').style.display = 'flex';
        }

        function refreshSystems() {
            showNotification('جاري تحديث قائمة الأنظمة...', 'info');
            loadSystems();
        }

        // Additional placeholder functions
        async function optimizeStorage() {
            showNotification('جاري تحسين التخزين...', 'info');
            // Implement storage optimization
        }

        async function createFullBackup() {
            showNotification('جاري إنشاء نسخة احتياطية كاملة...', 'info');
            // Implement full system backup
        }

        async function saveSystemChanges(systemName) {
            showNotification('جاري حفظ التغييرات...', 'info');
            // Implement save changes
        }

        async function optimizeSystem(systemName) {
            showNotification(`جاري تحسين ${systemName}...`, 'info');
            // Implement system optimization
        }

        async function updateSystem(systemName) {
            showNotification(`جاري تحديث ${systemName}...`, 'info');
            // Implement system update
        }

        async function restoreBackup(backupPath) {
            if (!confirm('هل تريد استعادة هذه النسخة الاحتياطية؟')) return;
            
            try {
                showNotification('جاري استعادة النسخة الاحتياطية...', 'info');
                
                const response = await fetch('/api/backups/restore', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ backup_path: backupPath })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('تم استعادة النسخة الاحتياطية بنجاح', 'success');
                    closeModal('backupsModal');
                    loadSystems();
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('خطأ في استعادة النسخة الاحتياطية:', error);
                showNotification('فشل في استعادة النسخة الاحتياطية', 'error');
            }
        }

        async function deleteBackup(backupPath) {
            if (!confirm('هل تريد حذف هذه النسخة الاحتياطية نهائياً؟')) return;
            
            try {
                const response = await fetch('/api/backups/delete', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ backup_path: backupPath })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('تم حذف النسخة الاحتياطية', 'success');
                    loadBackups(); // Reload backups list
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('خطأ في حذف النسخة الاحتياطية:', error);
                showNotification('فشل في حذف النسخة الاحتياطية', 'error');
            }
        }

        // =====================================
        // Keyboard Shortcuts
        // =====================================
        document.addEventListener('keydown', function(event) {
            // Escape - close any open modal
            if (event.key === 'Escape') {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    if (modal.style.display === 'flex') {
                        modal.style.display = 'none';
                    }
                });
                
                // Hide upload section
                document.getElementById('uploadSection').style.display = 'none';
                selectedFile = null;
                document.getElementById('fileInput').value = '';
            }
            
            // Ctrl+U - show upload modal
            if (event.ctrlKey && event.key === 'u') {
                event.preventDefault();
                showUploadModal();
            }
            
            // Ctrl+R - refresh systems
            if (event.ctrlKey && event.key === 'r') {
                event.preventDefault();
                refreshSystems();
            }
            
            // Ctrl+B - show backups
            if (event.ctrlKey && event.key === 'b') {
                event.preventDefault();
                showBackupsModal();
            }
        });

        // =====================================
        // Touch/Swipe Support for Mobile
        // =====================================
        let touchStartX = 0;
        let touchStartY = 0;

        document.addEventListener('touchstart', function(e) {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        });

        document.addEventListener('touchend', function(e) {
            if (!touchStartX || !touchStartY) return;

            let touchEndX = e.changedTouches[0].clientX;
            let touchEndY = e.changedTouches[0].clientY;

            let diffX = touchStartX - touchEndX;
            let diffY = touchStartY - touchEndY;

            // Allow horizontal swipe for navigation
            if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                if (diffX > 0) {
                    // Swipe left - next page
                    window.location.href = '/settings';
                } else {
                    // Swipe right - previous page
                    window.location.href = '/troubleshoot';
                }
            }

            touchStartX = 0;
            touchStartY = 0;
        });

        // =====================================
        // Auto-refresh and Error Handling
        // =====================================
        let refreshInterval;

        function startAutoRefresh() {
            refreshInterval = setInterval(() => {
                // Only refresh if no modals are open
                const openModals = document.querySelectorAll('.modal[style*="flex"]');
                if (openModals.length === 0) {
                    loadSystems();
                }
            }, 60000); // Refresh every minute
        }

        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        // Start auto-refresh when page is visible
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible') {
                startAutoRefresh();
                loadSystems(); // Refresh immediately when page becomes visible
            } else {
                stopAutoRefresh();
            }
        });

        // Start auto-refresh on load
        window.addEventListener('load', startAutoRefresh);

        // Stop auto-refresh on unload
        window.addEventListener('beforeunload', stopAutoRefresh);

        // =====================================
        // Error Handling
        // =====================================
        window.addEventListener('error', function(event) {
            console.error('JavaScript Error:', event.error);
            showNotification('حدث خطأ في التطبيق', 'error');
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled Promise Rejection:', event.reason);
            showNotification('خطأ في العملية المطلوبة', 'error');
        });

        // =====================================
        // Performance Monitoring
        // =====================================
        if ('performance' in window) {
            window.addEventListener('load', function() {
                const loadTime = performance.now();
                console.log(`Page load time: ${loadTime.toFixed(2)}ms`);
                
                // Report slow loading
                if (loadTime > 3000) {
                    console.warn('Slow page load detected');
                }
            });
        }

        // =====================================
        // Accessibility Enhancements
        // =====================================
        
        // Add focus management for modals
        function focusModal(modalId) {
            const modal = document.getElementById(modalId);
            const focusableElements = modal.querySelectorAll(
                'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
            );
            
            if (focusableElements.length > 0) {
                focusableElements[0].focus();
            }
        }

        // Enhance modal opening to include focus management
        const originalShowInstallModal = showInstallModal;
        showInstallModal = function() {
            originalShowInstallModal();
            setTimeout(() => focusModal('installModal'), 100);
        };

        // Add ARIA labels and roles for better accessibility
        document.addEventListener('DOMContentLoaded', function() {
            // Add ARIA labels to action buttons
            const actionButtons = document.querySelectorAll('.btn');
            actionButtons.forEach(button => {
                if (!button.getAttribute('aria-label')) {
                    button.setAttribute('aria-label', button.textContent.trim());
                }
            });

            // Add role and aria-expanded to modal triggers
            const modalTriggers = document.querySelectorAll('[onclick*="Modal"]');
            modalTriggers.forEach(trigger => {
                trigger.setAttribute('role', 'button');
                trigger.setAttribute('aria-expanded', 'false');
            });
        });

        // =====================================
        // Advanced Features
        // =====================================

        // System comparison feature
        function compareSystem(systemName) {
            // Implementation for system comparison
            console.log('Comparing system:', systemName);
        }

        // Bulk operations
        let selectedSystems = new Set();

        function toggleSystemSelection(systemName) {
            if (selectedSystems.has(systemName)) {
                selectedSystems.delete(systemName);
            } else {
                selectedSystems.add(systemName);
            }
            updateBulkActions();
        }

        function updateBulkActions() {
            const bulkActionBar = document.getElementById('bulkActionBar');
            if (selectedSystems.size > 0) {
                if (!bulkActionBar) {
                    createBulkActionBar();
                }
                document.getElementById('selectedCount').textContent = selectedSystems.size;
            } else if (bulkActionBar) {
                bulkActionBar.remove();
            }
        }

        function createBulkActionBar() {
            const actionBar = document.querySelector('.action-bar');
            const bulkBar = document.createElement('div');
            bulkBar.id = 'bulkActionBar';
            bulkBar.className = 'action-bar';
            bulkBar.style.background = 'var(--warning-color)';
            bulkBar.innerHTML = `
                <span>تم تحديد <span id="selectedCount">0</span> نظام</span>
                <button class="btn" onclick="bulkBackup()">💾 نسخ احتياطي جماعي</button>
                <button class="btn danger" onclick="bulkRemove()">🗑️ حذف جماعي</button>
                <button class="btn" onclick="clearSelection()">✖️ إلغاء التحديد</button>
            `;
            actionBar.parentNode.insertBefore(bulkBar, actionBar.nextSibling);
        }

        function clearSelection() {
            selectedSystems.clear();
            updateBulkActions();
            
            // Remove selection styling from cards
            document.querySelectorAll('.system-card.selected').forEach(card => {
                card.classList.remove('selected');
            });
        }

        function bulkBackup() {
            if (selectedSystems.size === 0) return;
            
            if (confirm(`إنشاء نسخة احتياطية من ${selectedSystems.size} نظام؟`)) {
                selectedSystems.forEach(systemName => {
                    backupSystem(systemName);
                });
                clearSelection();
            }
        }

        function bulkRemove() {
            if (selectedSystems.size === 0) return;
            
            if (confirm(`حذف ${selectedSystems.size} نظام نهائياً؟\n\nهذا الإجراء لا يمكن التراجع عنه.`)) {
                selectedSystems.forEach(systemName => {
                    removeSystem(systemName);
                });
                clearSelection();
            }
        }

        // Search and filter functionality
        function setupSearchFilter() {
            const searchInput = document.createElement('input');
            searchInput.type = 'text';
            searchInput.placeholder = '🔍 البحث في الأنظمة...';
            searchInput.className = 'form-input';
            searchInput.style.maxWidth = '300px';
            searchInput.style.margin = '0 auto 20px';
            
            searchInput.addEventListener('input', (e) => {
                filterSystems(e.target.value);
            });
            
            const header = document.querySelector('.header');
            header.appendChild(searchInput);
        }

        function filterSystems(searchTerm) {
            const systemCards = document.querySelectorAll('.system-card');
            const term = searchTerm.toLowerCase();
            
            systemCards.forEach(card => {
                const systemName = card.querySelector('.system-name')?.textContent.toLowerCase() || '';
                const systemDescription = card.querySelector('.system-description')?.textContent.toLowerCase() || '';
                const systemType = card.querySelector('.system-type')?.textContent.toLowerCase() || '';
                
                const matches = systemName.includes(term) || 
                               systemDescription.includes(term) || 
                               systemType.includes(term);
                
                card.style.display = matches ? 'block' : 'none';
            });
        }

        // Initialize advanced features
        document.addEventListener('DOMContentLoaded', function() {
            setupSearchFilter();
        });
    </script>
</body>
</html><!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎮 DOS Safar - إدارة أنظمة التشغيل</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2a5298;
            --secondary-color: #1e3c72;
            --accent-color: #ffd700;
            --success-color: #00b894;
            --warning-color: #fdcb6e;
            --danger-color: #e17055;
            --text-light: #ffffff;
            --text-dark: #2d3436;
            --bg-dark: #1a1a1a;
            --bg-card: rgba(255, 255, 255, 0.1);
            --border-color: rgba(255, 255, 255, 0.2);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--primary-color) 100%);
            color: var(--text-light);
            min-height: 100vh;
            padding-bottom: 80px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--bg-card);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, var(--accent-color), #fff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .action-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: var(--text-light);
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .btn.success {
            background: linear-gradient(45deg, var(--success-color), #00a085);
        }

        .btn.warning {
            background: linear-gradient(45deg, var(--warning-color), #e17055);
        }

        .btn.danger {
            background: linear-gradient(45deg, var(--danger-color), #d63031);
        }

        .systems-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .system-card {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .system-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        }

        .system-card.current {
            border-left: 5px solid var(--accent-color);
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), var(--bg-card));
        }

        .system-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .system-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .system-name {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .system-type {
            background: var(--primary-color);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .system-description {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .system-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85em;
        }

        .stat-label {
            opacity: 0.7;
            font-size: 0.8em;
        }

        .stat-value {
            font-weight: bold;
            margin-top: 2px;
        }

        .system-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.8em;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }

        .btn-boot {
            background: var(--success-color);
        }

        .btn-manage {
            background: var(--primary-color);
        }

        .btn-backup {
            background: var(--warning-color);
        }

        .btn-remove {
            background: var(--danger-color);
        }

        .btn-small:hover {
            transform: scale(1.05);
            opacity: 0.9;
        }

        .upload-section {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid var(--border-color);
            margin-bottom: 30px;
        }

        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: var(--accent-color);
            background: rgba(255, 215, 0, 0.1);
        }

        .upload-area.dragover {
            border-color: var(--accent-color);
            background: rgba(255, 215, 0, 0.2);
            transform: scale(1.02);
        }

        .file-input {
            display: none;
        }

        .upload-icon {
            font-size: 4em;
            margin-bottom: 15px;
            opacity: 0.7;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: var(--success-color);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .backups-section {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid var(--border-color);
            margin-bottom: 30px;
        }

        .backup-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .backup-info {
            flex: 1;
        }

        .backup-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .backup-details {
            font-size: 0.8em;
            opacity: 0.7;
        }

        .backup-actions {
            display: flex;
            gap: 8px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--bg-dark);
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
        }

        .modal-title {
            font-size: 1.3em;
            font-weight: bold;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 1.5em;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: var(--danger-color);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            font-size: 1em;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.2);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 1001;
            max-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: var(--danger-color);
        }

        .notification.warning {
            background: var(--warning-color);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .footer-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-dark);
            border-top: 1px solid var(--border-color);
            padding: 15px;
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .nav-item {
            background: var(--bg-card);
            color: var(--text-light);
            text-decoration: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9em;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-item:hover {
            background: var(--primary-color);
            transform: translateY(-2px);
        }

        .nav-item.active {
            background: var(--accent-color);
            color: var(--text-dark);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .systems-grid {
                grid-template-columns: 1fr;
            }

            .action-bar {
                flex-direction: column;
            }

            .system-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .system-stats {
                grid-template-columns: 1fr;
            }

            .footer-nav {
                padding: 10px;
                gap: 10px;
            }

            .nav-item {
                padding: 8px 12px;
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>💿 إدارة أنظمة التشغيل</h1>
            <p>إدارة وتثبيت أنظمة التشغيل على جهازك</p>
        </div>

        <!-- Action Bar -->
        <div class="action-bar">
            <button class="btn success" onclick="showUploadModal()">
                📥 تثبيت نظام جديد
            </button>
            <button class="btn" onclick="refreshSystems()">
                🔄 تحديث القائمة
            </button>
            <button class="btn warning" onclick="showBackupsModal()">
                💾 النسخ الاحتياطية
            </button>
            <button class="btn" onclick="optimizeStorage()">
                🗂️ تحسين التخزين
            </button>
            <a href="/settings" class="btn">
                ⚙️ الإعدادات
            </a>
        </div>

        <!-- Systems Grid -->
        <div class="systems-grid" id="systemsGrid">
            <!-- Loading placeholder -->
            <div class="system-card">
                <div class="loading"></div>
                <span>جاري تحميل أنظمة التشغيل...</span>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="upload-section" id="uploadSection" style="display: none;">
            <h2>📥 تثبيت نظام تشغيل جديد</h2>
            <div class="upload-area" onclick="document.getElementById('fileInput').click()" id="uploadArea">
                <div class="upload-icon">📁</div>
                <h3>اسحب وأفلت ملف النظام هنا</h3>
                <p>أو انقر للاختيار من الجهاز</p>
                <small>الصيغ المدعومة: .img, .iso, .tar.gz, .zip</small>
                <input type="file" id="fileInput" class="file-input" accept=