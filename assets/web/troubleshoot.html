<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOS Safar - Hardware Troubleshooting</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .screen-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
        }

        .screen-viewer {
            width: 100%;
            height: 400px;
            background: #000;
            border: 2px solid #333;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
        }

        .screen-placeholder {
            text-align: center;
            color: #888;
        }

        .screen-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        .btn.secondary {
            background: linear-gradient(45deg, #74b9ff, #0984e3);
        }

        .btn.success {
            background: linear-gradient(45deg, #00b894, #00a085);
        }

        .btn.danger {
            background: linear-gradient(45deg, #d63031, #e17055);
        }

        .control-panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
        }

        .section {
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .section h3 {
            margin-bottom: 15px;
            color: #ffd700;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 5px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 8px 0;
        }

        .setting-item:last-child {
            margin-bottom: 0;
        }

        select, input[type="range"], input[type="text"] {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            min-width: 120px;
        }

        select option {
            background: #2a2a2a;
            color: white;
        }

        .test-results {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            font-size: 14px;
        }

        .test-pass {
            background: rgba(0, 184, 148, 0.2);
            border: 1px solid #00b894;
        }

        .test-fail {
            background: rgba(214, 48, 49, 0.2);
            border: 1px solid #d63031;
        }

        .virtual-keyboard {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 5px;
            margin-top: 10px;
        }

        .key {
            background: #333;
            border: none;
            color: white;
            padding: 8px 4px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .key:active, .key.pressed {
            background: #555;
            transform: scale(0.95);
        }

        .resolution-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 10px;
        }

        .resolution-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            text-align: center;
        }

        .resolution-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .resolution-btn.active {
            background: #00b894;
            border-color: #00b894;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .screen-viewer {
                height: 250px;
            }
            
            .virtual-keyboard {
                grid-template-columns: repeat(8, 1fr);
            }
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .network-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .signal-bars {
            display: flex;
            gap: 2px;
        }

        .bar {
            width: 3px;
            height: 12px;
            background: #00b894;
            border-radius: 1px;
        }

        .bar.weak { opacity: 0.3; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß DOS Safar Hardware Troubleshooting</h1>
            <p>Fix display, keyboard, and network issues remotely</p>
        </div>

        <div class="status-bar">
            <div class="network-info">
                <span>üì∂ Network:</span>
                <span id="networkName">Connected</span>
                <div class="signal-bars">
                    <div class="bar"></div>
                    <div class="bar"></div>
                    <div class="bar"></div>
                    <div class="bar"></div>
                </div>
            </div>
            <div>
                <span>üñ•Ô∏è Device:</span>
                <span id="deviceName">Loading...</span>
            </div>
            <div>
                <span>üìç IP:</span>
                <span id="deviceIP">192.168.1.100</span>
            </div>
        </div>

        <div class="main-grid">
            <!-- Screen Viewer Section -->
            <div class="screen-section">
                <h2>üñ•Ô∏è Screen Viewer & Display Settings</h2>
                
                <div class="screen-viewer" id="screenViewer">
                    <div class="screen-placeholder">
                        <div>üì∫ Live Screen Preview</div>
                        <small>Click "Capture Screen" to view current display</small>
                    </div>
                </div>

                <div class="screen-controls">
                    <button class="btn" onclick="captureScreen()">üì∏ Capture Screen</button>
                    <button class="btn secondary" onclick="refreshScreen()">üîÑ Refresh</button>
                    <button class="btn success" onclick="testDisplay()">üîß Test Display</button>
                    <button class="btn danger" onclick="resetDisplay()">‚ö†Ô∏è Reset Display</button>
                </div>

                <div class="section">
                    <h3>Display Resolution</h3>
                    <div class="resolution-grid">
                        <div class="resolution-btn" onclick="setResolution(1920, 1080)">1920√ó1080</div>
                        <div class="resolution-btn" onclick="setResolution(1280, 720)">1280√ó720</div>
                        <div class="resolution-btn active" onclick="setResolution(1024, 768)">1024√ó768</div>
                        <div class="resolution-btn" onclick="setResolution(800, 600)">800√ó600</div>
                        <div class="resolution-btn" onclick="setResolution(480, 320)">480√ó320</div>
                        <div class="resolution-btn" onclick="setResolution(0, 0)">Auto</div>
                    </div>
                </div>

                <div class="section">
                    <h3>Display Settings</h3>
                    <div class="setting-item">
                        <label>Brightness:</label>
                        <input type="range" min="10" max="100" value="80" onchange="setBrightness(this.value)">
                    </div>
                    <div class="setting-item">
                        <label>Refresh Rate:</label>
                        <select onchange="setRefreshRate(this.value)">
                            <option value="60">60 Hz</option>
                            <option value="75">75 Hz</option>
                            <option value="90">90 Hz</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label>Color Depth:</label>
                        <select onchange="setColorDepth(this.value)">
                            <option value="16">16-bit</option>
                            <option value="24" selected>24-bit</option>
                            <option value="32">32-bit</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Control Panel Section -->
            <div class="control-panel">
                <div class="section">
                    <h3>‚å®Ô∏è Keyboard Test</h3>
                    <input type="text" placeholder="Type here to test keyboard..." 
                           onkeydown="testKeyboard(event)" style="width: 100%; margin-bottom: 10px;">
                    
                    <div class="virtual-keyboard">
                        <button class="key" onclick="sendKey('1')">1</button>
                        <button class="key" onclick="sendKey('2')">2</button>
                        <button class="key" onclick="sendKey('3')">3</button>
                        <button class="key" onclick="sendKey('4')">4</button>
                        <button class="key" onclick="sendKey('5')">5</button>
                        <button class="key" onclick="sendKey('6')">6</button>
                        <button class="key" onclick="sendKey('7')">7</button>
                        <button class="key" onclick="sendKey('8')">8</button>
                        <button class="key" onclick="sendKey('9')">9</button>
                        <button class="key" onclick="sendKey('0')">0</button>
                        
                        <button class="key" onclick="sendKey('q')">Q</button>
                        <button class="key" onclick="sendKey('w')">W</button>
                        <button class="key" onclick="sendKey('e')">E</button>
                        <button class="key" onclick="sendKey('r')">R</button>
                        <button class="key" onclick="sendKey('t')">T</button>
                        <button class="key" onclick="sendKey('y')">Y</button>
                        <button class="key" onclick="sendKey('u')">U</button>
                        <button class="key" onclick="sendKey('i')">I</button>
                        <button class="key" onclick="sendKey('o')">O</button>
                        <button class="key" onclick="sendKey('p')">P</button>
                    </div>
                    
                    <div id="keyboardTestResult" class="test-results" style="display: none;"></div>
                </div>

                <div class="section">
                    <h3>üéÆ Gaming Controls</h3>
                    <div class="setting-item">
                        <span>D-Pad:</span>
                        <button class="btn" onclick="testGamepad('dpad')">Test</button>
                    </div>
                    <div class="setting-item">
                        <span>Action Buttons:</span>
                        <button class="btn" onclick="testGamepad('buttons')">Test</button>
                    </div>
                    <div class="setting-item">
                        <span>Analog Sticks:</span>
                        <button class="btn" onclick="testGamepad('analog')">Test</button>
                    </div>
                    
                    <div id="gamepadTestResult" class="test-results" style="display: none;"></div>
                </div>

                <div class="section">
                    <h3>üåê Network Settings</h3>
                    <div class="setting-item">
                        <span>WiFi Network:</span>
                        <button class="btn secondary" onclick="scanNetworks()">üîç Scan</button>
                    </div>
                    <div class="setting-item">
                        <span>Connection:</span>
                        <button class="btn success" onclick="testConnection()">üîó Test</button>
                    </div>
                    
                    <div id="networkList" style="display: none; margin-top: 10px;"></div>
                </div>

                <div class="section">
                    <h3>üîß Quick Actions</h3>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <button class="btn" onclick="runFullTest()">üß™ Run All Tests</button>
                        <button class="btn secondary" onclick="saveCurrentSettings()">üíæ Save Settings</button>
                        <button class="btn success" onclick="applyOptimalSettings()">‚ö° Auto-Fix</button>
                        <button class="btn danger" onclick="resetAllSettings()">üîÑ Reset All</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load device info on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadDeviceInfo();
            updateNetworkInfo();
            setInterval(updateNetworkInfo, 10000); // Update every 10 seconds
        });

        async function loadDeviceInfo() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();
                document.getElementById('deviceName').textContent = status.device_model;
                document.getElementById('deviceIP').textContent = status.network_status.ip_address;
            } catch (error) {
                console.error('Failed to load device info:', error);
            }
        }

        async function updateNetworkInfo() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();
                
                if (status.network_status.connected) {
                    document.getElementById('networkName').textContent = 'Connected';
                    // Update signal bars based on strength
                    updateSignalBars(status.network_status.signal_strength || -50);
                } else {
                    document.getElementById('networkName').textContent = 'Disconnected';
                    updateSignalBars(-100);
                }
            } catch (error) {
                console.error('Failed to update network info:', error);
            }
        }

        function updateSignalBars(strength) {
            const bars = document.querySelectorAll('.bar');
            bars.forEach((bar, index) => {
                if (strength > -70 - (index * 10)) {
                    bar.classList.remove('weak');
                } else {
                    bar.classList.add('weak');
                }
            });
        }

        async function captureScreen() {
            const viewer = document.getElementById('screenViewer');
            viewer.innerHTML = '<div class="loading"></div>Capturing screen...';
            
            try {
                const response = await fetch('/api/screenshot');
                const data = await response.json();
                
                viewer.innerHTML = `<img src="${data.image_data}" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
            } catch (error) {
                viewer.innerHTML = '<div class="screen-placeholder"><div>‚ùå Failed to capture screen</div><small>Check connection and try again</small></div>';
            }
        }

        function refreshScreen() {
            captureScreen();
        }

        async function testDisplay() {
            showTestResult('display', 'running', 'Testing display configuration...');
            
            try {
                const response = await fetch('/api/test/display', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    showTestResult('display', 'pass', `Display test passed: ${result.resolution}`);
                } else {
                    showTestResult('display', 'fail', `Display test failed: ${result.error}`);
                }
            } catch (error) {
                showTestResult('display', 'fail', 'Failed to run display test');
            }
        }

        async function setResolution(width, height) {
            // Remove active class from all buttons
            document.querySelectorAll('.resolution-btn').forEach(btn => btn.classList.remove('active'));
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            try {
                await fetch('/api/display/resolution', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ width, height })
                });
                
                setTimeout(captureScreen, 1000); // Refresh screen after resolution change
            } catch (error) {
                console.error('Failed to set resolution:', error);
            }
        }

        function testKeyboard(event) {
            const result = document.getElementById('keyboardTestResult');
            result.style.display = 'block';
            result.className = 'test-results test-pass';
            result.textContent = `Key detected: ${event.key} (Code: ${event.keyCode})`;
        }

        function sendKey(key) {
            // Visual feedback
            event.target.classList.add('pressed');
            setTimeout(() => event.target.classList.remove('pressed'), 150);
            
            // Send key to system
            fetch('/api/input/key', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ key: key })
            });
        }

        async function testGamepad(type) {
            showTestResult('gamepad', 'running', `Testing ${type}...`);
            
            try {
                const response = await fetch(`/api/test/gamepad/${type}`, { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    showTestResult('gamepad', 'pass', `${type} test passed`);
                } else {
                    showTestResult('gamepad', 'fail', `${type} test failed: ${result.error}`);
                }
            } catch (error) {
                showTestResult('gamepad', 'fail', `Failed to test ${type}`);
            }
        }

        async function scanNetworks() {
            const networkList = document.getElementById('networkList');
            networkList.style.display = 'block';
            networkList.innerHTML = '<div class="loading"></div>Scanning networks...';
            
            try {
                const response = await fetch('/api/network/scan');
                const networks = await response.json();
                
                networkList.innerHTML = networks.map(network => `
                    <div style="padding: 8px; background: rgba(255,255,255,0.1); margin: 4px 0; border-radius: 4px; cursor: pointer;" 
                         onclick="connectToNetwork('${network.ssid}')">
                        <strong>${network.ssid}</strong><br>
                        <small>Signal: ${network.signal} dBm | Security: ${network.security}</small>
                    </div>
                `).join('');
            } catch (error) {
                networkList.innerHTML = '<div style="color: #d63031;">Failed to scan networks</div>';
            }
        }

        async function connectToNetwork(ssid) {
            if (confirm(`Connect to ${ssid}?`)) {
                try {
                    const response = await fetch('/api/network/connect', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ssid })
                    });
                    
                    const result = await response.json();
                    alert(`Connected to ${ssid}: ${result.ip}`);
                    updateNetworkInfo();
                } catch (error) {
                    alert('Failed to connect to network');
                }
            }
        }

        async function runFullTest() {
            alert('Running comprehensive hardware tests...');
            await testDisplay();
            await testGamepad('dpad');
            await testGamepad('buttons');
        }

        function saveCurrentSettings() {
            alert('Current settings saved successfully!');
        }

        function applyOptimalSettings() {
            if (confirm('Apply automatic optimal settings? This will reset display and input configurations.')) {
                fetch('/api/settings/auto-optimize', { method: 'POST' })
                    .then(() => {
                        alert('Optimal settings applied! Screen will refresh.');
                        setTimeout(captureScreen, 2000);
                    });
            }
        }

        function resetAllSettings() {
            if (confirm('Reset all settings to defaults? This cannot be undone.')) {
                fetch('/api/settings/reset', { method: 'POST' })
                    .then(() => {
                        alert('Settings reset to defaults. Restarting...');
                        setTimeout(() => location.reload(), 2000);
                    });
            }
        }

        function showTestResult(type, status, message) {
            const resultId = type + 'TestResult';
            const result = document.getElementById(resultId);
            
            if (result) {
                result.style.display = 'block';
                result.className = `test-results test-${status === 'pass' ? 'pass' : 'fail'}`;
                
                if (status === 'running') {
                    result.innerHTML = `<div class="loading"></div>${message}`;
                } else {
                    result.textContent = message;
                }
            }
        }

        // Additional functions for other controls...
        function setBrightness(value) {
            fetch('/api/display/brightness', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ brightness: parseInt(value) })
            });
        }

        function setRefreshRate(value) {
            fetch('/api/display/refresh-rate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ refresh_rate: parseInt(value) })
            });
        }

        function setColorDepth(value) {
            fetch('/api/display/color-depth', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ color_depth: parseInt(value) })
            });
        }

        function resetDisplay() {
            if (confirm('Reset display settings to safe defaults?')) {
                fetch('/api/display/reset', { method: 'POST' })
                    .then(() => {
                        alert('Display reset to safe mode.');
                        setTimeout(captureScreen, 1000);
                    });
            }
        }

        function testConnection() {
            fetch('/api/network/test')
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert(`Connection test passed!\nPing: ${result.ping}ms\nSpeed: ${result.speed}`);
                    } else {
                        alert(`Connection test failed: ${result.error}`);
                    }
                });
        }
    </script>
</body>
</html>